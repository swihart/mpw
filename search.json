[{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"psalphaalpha0-positive-stable-frailty-example","dir":"Articles","previous_headings":"","what":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example","title":"Weibull-Weibull-Positive Stable","text":"FαF_{\\alpha} referenced manuscript: Fα(x)=1−exp[−expαη]F_{\\alpha}(x) = 1-\\exp[-\\exp\\alpha\\eta] PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty density: fui(ui|α)=−1πui∑k=1∞Γ(kα+1)k!(−ui−α)ksin(αkπ)f_{u_{}}(u_{} | \\alpha) =  - \\frac{1}{\\pi u_{}}  \\sum_{k=1}^\\infty \\frac{\\Gamma(k \\alpha +1)}{k!}  (-u_{}^{-\\alpha})^k \\sin{(\\alpha k \\pi)} analyze data looks similar Figure 2 Thomas et al (2021) Safety Efficacy BNT162b2 mRNA Covid-19 Vaccine 6 Months. plot data points, color-code groups, just connect dots interpolated, dashed lines.  Set h_parm frailty distribution example. Beware H_PARM different bounds depending value FRAILTY selected. first consider two knots allow us model curve three pieces. set first piece group equal can get HR 1 (subsequent sections). first piece can specified short time range groups considered equal due ramp-time vaccine. set ramp-time end 5 days first dose, second piece go 90 days second dose, third piece end study. specifying two knot values, :","code":"library(mpw) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  ## plot the data points,  ## with interpolated lines plot  (time, F0, type=\"l\", col=\"black\", xlab=\"Days\", ylab=\"CDF\", lty=2) points(time, F0, col=\"black\", pch=15) lines (time, F1, col=\"blue\", lty=2) points(time, F1, col=\"blue\", pch=16) legend(\"topleft\", c(\"Placebo\", \"Vaccine\"),        col=c(\"black\",\"blue\"),        lty=1,        pch=c(15,16) ) H_PARM <- 0.72 FRAILTY <- \"PS\""},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"two-knots","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example","what":"Two knots","title":"Weibull-Weibull-Positive Stable","text":"","code":"tvec.in <- c(5, 90+21) tvec.in #> [1]   5 111"},{"path":[]},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"fit-for-placebo-group","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Two knots > Two step fitting procedure","what":"1. Fit for placebo group","title":"Weibull-Weibull-Positive Stable","text":"","code":"fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F0)^2) }  init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in))) plac_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_alpha) #> $par #> [1]  -0.8590240 -11.5514302   1.6053115  -0.3700213 #>  #> $value #> [1] 1.574351e-06 #>  #> $counts #> function gradient  #>      167       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_alpha$par[1] g0p = plac_fit_F_alpha$par[2] delta_vec_p =plac_fit_F_alpha$par[-1*c(1,2)]"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"fit-for-vaccine-group","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Two knots > Two step fitting procedure","what":"2. Fit for vaccine group","title":"Weibull-Weibull-Positive Stable","text":"Now take logk0p g0p, parameters control first (leftmost) piece placebo group use logk0v g0v estimating pieces vaccine group. forces first pieces groups (.e. ramp-time).","code":"fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=logk0p,                                              g0=g0p,                                              delta_vec=x,                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F1)^2) }  init.vals <- rep( 0,length(tvec.in)) vacc_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(vacc_fit_F_alpha) #> $par #> [1] 0.6274834 0.9321016 #>  #> $value #> [1] 1.41648e-07 #>  #> $counts #> function gradient  #>       75       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0v = logk0p g0v = g0p delta_vec_v =vacc_fit_F_alpha$par"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"plot-population-avg-cdf","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Two knots","what":"Plot population avg CDF","title":"Weibull-Weibull-Positive Stable","text":"Quick check fit use knots original time time.dist quick check fit. put vertical dashed lines plot denote knot placement.  Note Days 0 5 curves . range HR 1. Otherwise fit looks okay – points line .","code":"time.dist <- sort(c(seq(min(c(time, tvec.in)),                          max(c(time, tvec.in)), 0.1),                     tvec.in)                   )  plac.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)    plot  (time.dist, plac.dist, type=\"l\", col=\"black\", xlab=\"Days\", ylab=\"CDF\") points(time     , F0       , col=\"black\", pch=15) lines (time.dist, vacc.dist, col=\"blue\") points(time     , F1, col=\"blue\", pch=16) abline(v=tvec.in, lty=2, col=\"grey\") legend(\"topleft\", c(\"Placebo\", \"Vaccine\"),        col=c(\"black\",\"blue\"),        lty=1,        pch=c(15,16) ) axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"plot-population-avg-hr","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Two knots","what":"Plot population avg HR","title":"Weibull-Weibull-Positive Stable","text":"uses parameters two step fitting procedure HR(0) = 1 use parameters previous fits estimate population average hazard, can fit mpw::popavg_haz(). adjust time input first element just 0.","code":"time.haz <- c(1e-4, time.dist[-1]) plac.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  abline(v=tvec.in, lty=2, col=\"grey\")  axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"add-subject-specific-hrs","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Two knots","what":"Add subject-specific HRs","title":"Weibull-Weibull-Positive Stable","text":"flatten function mpw::subjspec_haz() require arguments frailty h_parm takes inputs b,k, delta pieces models subject-specific (aka conditional) hazard. placebo group, vaccine group dividing gives subject-specific hazard ratio (HR).  plot shows positive-stable frailty α\\alpha = 0.72 subject-specific HR flatter lower population average HR.","code":"plac.haz.ss <- subjspec_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p)  vacc.haz.ss <- subjspec_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  axis(1, at=c(tvec.in[1]))  lines  (time.haz, vacc.haz.ss/plac.haz.ss, type=\"l\", col=\"gold\", xlab=\"Days\",         lwd=2, lty=2) legend(\"topright\", c(\"Population HR\", \"Subject-specific HR\"),        col=c(\"purple\",\"gold\"),        lty=c(1,2),        lwd=2 )"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"sixteen-knots","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example","what":"Sixteen knots","title":"Weibull-Weibull-Positive Stable","text":"increasing knots, get “higher resolution” fit.","code":"tvec.in <- c(5, seq(14,max(time)-14,length.out=14),max(time)-7) tvec.in #>  [1]   5.00000  14.00000  26.92308  39.84615  52.76923  65.69231  78.61538 #>  [8]  91.53846 104.46154 117.38462 130.30769 143.23077 156.15385 169.07692 #> [15] 182.00000 189.00000"},{"path":[]},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"fit-for-placebo-group-1","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Sixteen knots > Two step fitting procedure","what":"1. Fit for placebo group","title":"Weibull-Weibull-Positive Stable","text":"","code":"fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F0)^2) }  init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in))) plac_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_alpha) #> $par #>  [1]  -0.19809428 -10.00290490  -0.46528979   1.50975780  -0.41049204 #>  [6]   0.13659323   0.10835991   0.26344501   0.18239172  -0.08269246 #> [11]  -0.07470972   0.19303094   0.05622029  -0.55575772  -0.99909140 #> [16]   0.53537197   0.38629201   0.88779139 #>  #> $value #> [1] 2.366405e-07 #>  #> $counts #> function gradient  #>      909       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_alpha$par[1] g0p = plac_fit_F_alpha$par[2] delta_vec_p =plac_fit_F_alpha$par[-1*c(1,2)]"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"fit-for-vaccine-group-1","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Sixteen knots > Two step fitting procedure","what":"2. Fit for vaccine group","title":"Weibull-Weibull-Positive Stable","text":"Now take logk0p g0p, parameters control first (leftmost) piece placebo group use logk0v g0v estimating pieces vaccine group. forces first pieces groups (.e. ramp-time).","code":"fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=logk0p,                                              g0=g0p,                                              delta_vec=x,                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F1)^2) }  init.vals <- rep( 0,length(tvec.in)) vacc_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(vacc_fit_F_alpha) #> $par #>  [1] -0.80982557 -0.01045652  0.62457154 -0.33277056 -0.21486434  0.42390586 #>  [7]  1.31843225 -0.36908115  1.26785248 -0.74096065  0.23847180 -0.30173673 #> [13] -0.44639190 -0.40910808  1.19813727  0.38037584 #>  #> $value #> [1] 1.488447e-08 #>  #> $counts #> function gradient  #>     2483       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0v = logk0p g0v = g0p delta_vec_v =vacc_fit_F_alpha$par"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"plot-population-avg-cdf-1","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Sixteen knots","what":"Plot population avg CDF","title":"Weibull-Weibull-Positive Stable","text":"Quick check fit use knots original time time.dist quick check fit. put vertical dashed lines plot denote knot placement.  Note Days 0 5 curves . Comparing two knot example, fit much improved.","code":"time.dist <- sort(c(seq(min(c(time, tvec.in)),                          max(c(time, tvec.in)), 0.1),                     tvec.in)                   )  plac.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)    plot  (time.dist, plac.dist, type=\"l\", col=\"black\", xlab=\"Days\", ylab=\"CDF\") points(time     , F0       , col=\"black\", pch=15) lines (time.dist, vacc.dist, col=\"blue\") points(time     , F1, col=\"blue\", pch=16) abline(v=tvec.in, lty=2, col=\"grey\") legend(\"topleft\", c(\"Placebo\", \"Vaccine\"),        col=c(\"black\",\"blue\"),        lty=1,        pch=c(15,16) ) axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"plot-population-avg-hr-1","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Sixteen knots","what":"Plot population avg HR","title":"Weibull-Weibull-Positive Stable","text":"uses parameters two step fitting procedure HR(0) = 1 use parameters previous fits estimate population average hazard, can fit mpw::popavg_haz(). adjust time input first element just 0.","code":"time.haz <- c(1e-4, time.dist[-1]) plac.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\", ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  abline(v=tvec.in, lty=2, col=\"grey\")  axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/alpha.html","id":"add-subject-specific-hrs-1","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Sixteen knots","what":"Add subject-specific HRs","title":"Weibull-Weibull-Positive Stable","text":"flatten function mpw::subjspec_haz() require arguments frailty h_parm takes inputs b,k, delta pieces models subject-specific (aka conditional) hazard. placebo group, vaccine group dividing gives subject-specific hazard ratio (HR).  plot shows positive-stable frailty α\\alpha = 0.72 subject-specific HR flatter lower population average HR.","code":"plac.haz.ss <- subjspec_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p)  vacc.haz.ss <- subjspec_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  axis(1, at=c(tvec.in[1]))  lines  (time.haz, vacc.haz.ss/plac.haz.ss, type=\"l\", col=\"gold\", xlab=\"Days\",         lwd=2, lty=2) legend(\"topright\", c(\"Population HR\", \"Subject-specific HR\"),        col=c(\"purple\",\"gold\"),        lty=c(1,2),        lwd=2 )"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"gabetabeta-gamma-frailty-example","dir":"Articles","previous_headings":"","what":"GA(β,β\\beta,\\beta) Gamma Frailty Example","title":"Burr-Weibull-Gamma","text":"FβF_{\\beta} referenced manuscript: Fβ(x)=1−[1+1βexpη]−βF_{\\beta}(x) =  1- [        1 +       \\frac{1}{\\beta}    \\exp\\eta       ]^{- \\beta} GA(β,β\\beta,\\beta) Gamma Frailty density: fui(ui|β)=ββΓ(β)uiβ−1exp(−βui)f_{u_{}}(u_{} | \\beta) =   \\frac{\\beta^\\beta}{\\Gamma(\\beta)} u^{\\beta-1}_i \\exp(-\\beta u_i) analyze data looks similar Figure 2 Thomas et al (2021) Safety Efficacy BNT162b2 mRNA Covid-19 Vaccine 6 Months. plot data points, color-code groups, just connect dots interpolated, dashed lines.  Set h_parm frailty distribution example. Beware H_PARM different bounds depending value FRAILTY selected. first consider two knots allow us model curve three pieces. set first piece group equal can get HR 1 (subsequent sections). first piece can specified short time range groups considered equal due ramp-time vaccine. set ramp-time end 5 days first dose, second piece go 90 days second dose, third piece end study. specifying two knot values, :","code":"library(mpw) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  ## plot the data points,  ## with interpolated lines plot  (time, F0, type=\"l\", col=\"black\", xlab=\"Days\", ylab=\"CDF\", lty=2) points(time, F0, col=\"black\", pch=15) lines (time, F1, col=\"blue\", lty=2) points(time, F1, col=\"blue\", pch=16) legend(\"topleft\", c(\"Placebo\", \"Vaccine\"),        col=c(\"black\",\"blue\"),        lty=1,        pch=c(15,16) ) H_PARM <- 0.04 FRAILTY <- \"GA\""},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"two-knots","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example","what":"Two knots","title":"Burr-Weibull-Gamma","text":"","code":"tvec.in <- c(5, 90+21) tvec.in #> [1]   5 111"},{"path":[]},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"fit-for-placebo-group","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Two knots > Two step fitting procedure","what":"1. Fit for placebo group","title":"Burr-Weibull-Gamma","text":"","code":"fit_F_beta <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F0)^2) }  init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in))) plac_fit_F_beta <-    optim(init.vals, fit_F_beta,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_beta) #> $par #> [1]   0.3539405 -10.7669066   0.3857141   0.4338531 #>  #> $value #> [1] 1.498077e-06 #>  #> $counts #> function gradient  #>      153       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_beta$par[1] g0p = plac_fit_F_beta$par[2] delta_vec_p =plac_fit_F_beta$par[-1*c(1,2)]"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"fit-for-vaccine-group","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Two knots > Two step fitting procedure","what":"2. Fit for vaccine group","title":"Burr-Weibull-Gamma","text":"Now take logk0p g0p, parameters control first (leftmost) piece placebo group use logk0v g0v estimating pieces vaccine group. forces first pieces groups (.e. ramp-time).","code":"fit_F_beta <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=logk0p,                                              g0=g0p,                                              delta_vec=x,                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F1)^2) }  init.vals <- rep( 0,length(tvec.in)) vacc_fit_F_beta <-    optim(init.vals, fit_F_beta,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(vacc_fit_F_beta) #> $par #> [1] -0.4327863  0.4862969 #>  #> $value #> [1] 2.11765e-07 #>  #> $counts #> function gradient  #>       61       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0v = logk0p g0v = g0p delta_vec_v =vacc_fit_F_beta$par"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"plot-population-avg-cdf","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Two knots","what":"Plot population avg CDF","title":"Burr-Weibull-Gamma","text":"Quick check fit use knots original time time.dist quick check fit. put vertical dashed lines plot denote knot placement.  Note Days 0 5 curves . range HR 1. Otherwise fit looks okay – points line .","code":"time.dist <- sort(c(seq(min(c(time, tvec.in)),                          max(c(time, tvec.in)), 0.1),                     tvec.in)                   )  plac.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)    plot  (time.dist, plac.dist, type=\"l\", col=\"black\", xlab=\"Days\", ylab=\"CDF\") points(time     , F0       , col=\"black\", pch=15) lines (time.dist, vacc.dist, col=\"blue\") points(time     , F1, col=\"blue\", pch=16) abline(v=tvec.in, lty=2, col=\"grey\") legend(\"topleft\", c(\"Placebo\", \"Vaccine\"),        col=c(\"black\",\"blue\"),        lty=1,        pch=c(15,16) ) axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"plot-population-avg-hr","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Two knots","what":"Plot population avg HR","title":"Burr-Weibull-Gamma","text":"uses parameters two step fitting procedure HR(0) = 1 use parameters previous fits estimate population average hazard, can fit mpw::popavg_haz(). adjust time input first element just 0.","code":"time.haz <- c(1e-4, time.dist[-1]) plac.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  abline(v=tvec.in, lty=2, col=\"grey\")  axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"add-subject-specific-hrs","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Two knots","what":"Add subject-specific HRs","title":"Burr-Weibull-Gamma","text":"flatten function mpw::subjspec_haz() require arguments frailty h_parm takes inputs b,k, delta pieces models subject-specific (aka conditional) hazard. placebo group, vaccine group dividing gives subject-specific hazard ratio (HR).  plot shows positive-stable frailty β\\beta = 0.04 subject-specific HR flatter lower population average HR.","code":"plac.haz.ss <- subjspec_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p)  vacc.haz.ss <- subjspec_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  axis(1, at=c(tvec.in[1]))  lines  (time.haz, vacc.haz.ss/plac.haz.ss, type=\"l\", col=\"gold\", xlab=\"Days\",         lwd=2, lty=2) legend(\"topright\", c(\"Population HR\", \"Subject-specific HR\"),        col=c(\"purple\",\"gold\"),        lty=c(1,2),        lwd=2 )"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"sixteen-knots","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example","what":"Sixteen knots","title":"Burr-Weibull-Gamma","text":"increasing knots, get “higher resolution” fit.","code":"tvec.in <- c(5, seq(14,max(time)-14,length.out=14),max(time)-7) tvec.in #>  [1]   5.00000  14.00000  26.92308  39.84615  52.76923  65.69231  78.61538 #>  [8]  91.53846 104.46154 117.38462 130.30769 143.23077 156.15385 169.07692 #> [15] 182.00000 189.00000"},{"path":[]},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"fit-for-placebo-group-1","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Sixteen knots > Two step fitting procedure","what":"1. Fit for placebo group","title":"Burr-Weibull-Gamma","text":"","code":"fit_F_beta <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F0)^2) }  init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in))) plac_fit_F_beta <-    optim(init.vals, fit_F_beta,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_beta) #> $par #>  [1]   0.523256884 -10.061980989  -0.343286973   0.051466952  -0.120790053 #>  [6]   0.042242352   0.019460319  -0.006109866   1.183818242  -0.316110532 #> [11]  -0.234160335   0.613497081   0.294034546  -0.951672983  -0.560057694 #> [16]   0.549708194   0.562404770   0.146431026 #>  #> $value #> [1] 1.219135e-07 #>  #> $counts #> function gradient  #>     2923       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_beta$par[1] g0p = plac_fit_F_beta$par[2] delta_vec_p =plac_fit_F_beta$par[-1*c(1,2)]"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"fit-for-vaccine-group-1","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Sixteen knots > Two step fitting procedure","what":"2. Fit for vaccine group","title":"Burr-Weibull-Gamma","text":"Now take logk0p g0p, parameters control first (leftmost) piece placebo group use logk0v g0v estimating pieces vaccine group. forces first pieces groups (.e. ramp-time).","code":"fit_F_beta <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=logk0p,                                              g0=g0p,                                              delta_vec=x,                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F1)^2) }  init.vals <- rep( 0,length(tvec.in)) vacc_fit_F_beta <-    optim(init.vals, fit_F_beta,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(vacc_fit_F_beta) #> $par #>  [1] -0.6409172 -1.0051289  0.1717533  0.2957642 -0.2042821  0.2995559 #>  [7]  0.8121162 -1.1376272  1.8870262 -0.5380177  0.5290840 -0.8612000 #> [13] -0.3007488 -0.2667314  1.3707537  0.1496222 #>  #> $value #> [1] 1.757205e-08 #>  #> $counts #> function gradient  #>     2471       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0v = logk0p g0v = g0p delta_vec_v =vacc_fit_F_beta$par"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"plot-population-avg-cdf-1","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Sixteen knots","what":"Plot population avg CDF","title":"Burr-Weibull-Gamma","text":"Quick check fit use knots original time time.dist quick check fit. put vertical dashed lines plot denote knot placement.  Note Days 0 5 curves . Comparing two knot example, fit much improved.","code":"time.dist <- sort(c(seq(min(c(time, tvec.in)),                          max(c(time, tvec.in)), 0.1),                     tvec.in)                   )  plac.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)    plot  (time.dist, plac.dist, type=\"l\", col=\"black\", xlab=\"Days\", ylab=\"CDF\") points(time     , F0       , col=\"black\", pch=15) lines (time.dist, vacc.dist, col=\"blue\") points(time     , F1, col=\"blue\", pch=16) abline(v=tvec.in, lty=2, col=\"grey\") legend(\"topleft\", c(\"Placebo\", \"Vaccine\"),        col=c(\"black\",\"blue\"),        lty=1,        pch=c(15,16) ) axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"plot-population-avg-hr-1","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Sixteen knots","what":"Plot population avg HR","title":"Burr-Weibull-Gamma","text":"uses parameters two step fitting procedure HR(0) = 1 use parameters previous fits estimate population average hazard, can fit mpw::popavg_haz(). adjust time input first element just 0.","code":"time.haz <- c(1e-4, time.dist[-1]) plac.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\", ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  abline(v=tvec.in, lty=2, col=\"grey\")  axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/beta.html","id":"add-subject-specific-hrs-1","dir":"Articles","previous_headings":"GA(β,β\\beta,\\beta) Gamma Frailty Example > Sixteen knots","what":"Add subject-specific HRs","title":"Burr-Weibull-Gamma","text":"flatten function mpw::subjspec_haz() require arguments frailty h_parm takes inputs b,k, delta pieces models subject-specific (aka conditional) hazard. placebo group, vaccine group dividing gives subject-specific hazard ratio (HR).  plot shows gamma frailty β\\beta = 0.04 subject-specific HR flatter lower population average HR.","code":"plac.haz.ss <- subjspec_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p)  vacc.haz.ss <- subjspec_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  axis(1, at=c(tvec.in[1]))  lines  (time.haz, vacc.haz.ss/plac.haz.ss, type=\"l\", col=\"gold\", xlab=\"Days\",         lwd=2, lty=2) legend(\"topright\", c(\"Population HR\", \"Subject-specific HR\"),        col=c(\"purple\",\"gold\"),        lty=c(1,2),        lwd=2 )"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay-ipd.html","id":"psalphaalpha0-positive-stable-frailty-example","dir":"Articles","previous_headings":"","what":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example","title":"Fay et al. (2025) supporting materials","text":"FαF_{\\alpha}, marginalized piecewise Weibull CDF: Fα(x)=1−exp[−expαη]F_{\\alpha}(x) = 1-\\exp[-\\exp\\alpha\\eta] CDF result integrating piecewise weibull frailty model frailty PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty density: fui(ui|α)=−1πui∑k=1∞Γ(kα+1)k!(−ui−α)ksin(αkπ)f_{u_{}}(u_{} | \\alpha) =  - \\frac{1}{\\pi u_{}}  \\sum_{k=1}^\\infty \\frac{\\Gamma(k \\alpha +1)}{k!}  (-u_{}^{-\\alpha})^k \\sin{(\\alpha k \\pi)} analyze data looks similar Figure 2 Thomas et al (2021) Safety Efficacy BNT162b2 mRNA Covid-19 Vaccine 6 Months. accomplished creating dataset package, ipd_data using R package IPDfromKM. load data couple quick checks proceeding core example.    Set h_parm frailty distribution example. Beware H_PARM different bounds depending value FRAILTY selected. example, going estimate marginal parameters first can accomplish mitigating effect alpha, , setting global variable H_PARM=1.00 passed argument h_parm. first consider two knots allow us model curve three pieces. set first piece group equal can get HR 1 (subsequent sections). first piece can specified short time range groups considered equal due ramp-time vaccine. set ramp-time end 1 day first dose, second piece go 28 days first dose, third piece 56 days first dose, etc.","code":"library(survminer) library(survival) library(mpw)  data(ipd_data) dim(ipd_data) #> [1] 44939     3 head(ipd_data) #>   time status treat #> 1  0.5      0     0 #> 2  1.0      1     0 #> 3  1.0      1     0 #> 4  1.5      0     0 #> 5  1.5      0     0 #> 6  2.0      1     0   fit <- survfit(Surv(time, status) ~ treat,                data = ipd_data) ## zoomed in, inset, 11days # Visualize with survminer ggsurvplot(fit, data = ipd_data, risk.table = TRUE,             ylim=c(1,0.993), xlim=c(0,28), break.time.by=11,            fontsize=2.5,tables.height = 0.50) # Visualize with survminer ## full view; every 14 days ggsurvplot(fit, data = ipd_data, risk.table = TRUE,             ylim=c(1,0.925), break.time.by=14,            fontsize=2.5, tables.height = 0.50) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  ## plot the data points,  ## with interpolated lines plot  (time, F0, type=\"l\", col=\"black\", xlab=\"Days\", ylab=\"CDF\", lty=2) points(time, F0, col=\"black\", pch=15) lines (time, F1, col=\"blue\", lty=2) points(time, F1, col=\"blue\", pch=16) legend(\"topleft\", c(\"Placebo\", \"Vaccine\"),        col=c(\"black\",\"blue\"),        lty=1,        pch=c(15,16) ) H_PARM <- 1.00 FRAILTY <- \"PS\""},{"path":"https://swihart.github.io/mpw/articles/wwps-fay-ipd.html","id":"knot-selection","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example","what":"Knot selection","title":"Fay et al. (2025) supporting materials","text":"","code":"tvec.in<- c(1,28,56,84,112,140,168) tvec.in #> [1]   1  28  56  84 112 140 168"},{"path":[]},{"path":"https://swihart.github.io/mpw/articles/wwps-fay-ipd.html","id":"fit-for-placebo-group","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection > Two step fitting procedure","what":"1. Fit for placebo group","title":"Fay et al. (2025) supporting materials","text":"","code":"fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F0)^2) }  init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in))) plac_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_alpha) #> $par #> [1]  0.1602199 -9.4498573  0.1816194 -0.6323941  1.1084249 -0.6612064  0.5807145 #> [8] -0.8614969  0.2335560 #>  #> $value #> [1] 9.918573e-07 #>  #> $counts #> function gradient  #>      479       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_alpha$par[1] g0p = plac_fit_F_alpha$par[2] delta_vec_p =plac_fit_F_alpha$par[-1*c(1,2)]"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay-ipd.html","id":"fit-for-vaccine-group","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection > Two step fitting procedure","what":"2. Fit for vaccine group","title":"Fay et al. (2025) supporting materials","text":"Now take logk0p g0p, parameters control first (leftmost) piece placebo group use logk0v g0v estimating pieces vaccine group. forces first pieces groups (.e. ramp-time).","code":"fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=logk0p,                                              g0=g0p,                                              delta_vec=x,                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F1)^2) }  init.vals <- rep( 0,length(tvec.in)) vacc_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(vacc_fit_F_alpha) #> $par #> [1] -0.18224579 -0.82329339  0.23464110  1.05260310  0.01773164 -0.06979188 #> [7] -0.30021721 #>  #> $value #> [1] 6.401134e-08 #>  #> $counts #> function gradient  #>      436       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0v = logk0p g0v = g0p delta_vec_v =vacc_fit_F_alpha$par"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay-ipd.html","id":"plot-population-avg-cdf","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection","what":"Plot population avg CDF","title":"Fay et al. (2025) supporting materials","text":"Quick check fit use knots original time time.dist quick check fit. put vertical dashed lines plot denote knot placement.  Note Days 0 1 curves . range HR 1. Additionally, fit looks okay – points line .","code":"COL <- c(\"black\",\"grey\") LTY <- c(1,1) LWD <- c(2,6) plot(NA,NA,, type=\"l\", col=\"black\", lwd=2, ylim=c(0,0.08), ylab=\"Cumulative Incidence\",xlab=\"Day since Receipt of First Dose\",          main=c(\"Specified Knots: \",paste(round(tvec.in,1), collapse=\", \")), xlim=range(time))  time.dist <- sort(c(seq(min(c(time, tvec.in)),                          max(c(time, tvec.in)), 0.1),                     tvec.in)                   )   plac.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)      lines(c(0,time.dist), c(0,vacc.dist),  col=COL[2],lty=LTY[2],lwd=LWD[2])    points(time, F1, col=\"blue\") abline(v=tvec.in, lty=2, col=\"grey\")  points(time, F0, col=\"black\")    lines(c(0,time.dist), c(0,plac.dist),  col=COL[1],lty=LTY[1],lwd=LWD[1]) legend(\"topleft\",legend=c(expression(F[0](t)),expression(F[1](t))),col=COL,        lty=LTY,lwd=LWD)"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay-ipd.html","id":"plot-population-avg-hr","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection","what":"Plot population avg HR","title":"Fay et al. (2025) supporting materials","text":"uses parameters two step fitting procedure HR(0) = 1 use parameters previous fits estimate population average hazard, can fit mpw::popavg_haz(). adjust time input first element just 0.  , plot VE = 1-HR:","code":"time.haz <- c(1e-4, time.dist[-1]) plac.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  abline(v=tvec.in, lty=2, col=\"grey\")  axis(1, at=c(tvec.in[1])) plot  (time.haz, 1-vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Vaccine Efficacy\", lwd=2, ylim=c(-0.05,1.05))  abline(v=tvec.in, lty=2, col=\"grey\")  axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay-ipd.html","id":"plot-subject-specific-ves-for-different-alpha-values","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection","what":"Plot subject-specific VEs for different α\\alpha values","title":"Fay et al. (2025) supporting materials","text":"flatten articles website demonstrating mpw use cases, adding subject specific curves involves mpw::subjspec_haz() function. 1α\\frac{1}{\\alpha} approach, instead use mpw::popavg_haz() specifying h_parm 1/alpha plot subject specific curve. demonstrate individual-level VE might different population-level, code runs loop three specific values alpha:  plot shows positive-stable frailty, α\\alpha goes 0 subject-specific VE flatter, approaching VE=1. α\\alpha goes 1 VE individual approaches population. Conceptually, one might conclude VE waning time alpha 0.99. One conclude alpha 0.40. instances, population-level VE observed. Therefore takeaway make statements VE looking population-level curves.","code":"COL<- gray(c(0.7,.5,0)) LTY<-c(1,2,3) LWD<-c(6,4,2)  plot(NA,NA,, type=\"l\", col=\"black\", lwd=2, ylim=c(0,1), ylab=expression(VE[h]),xlab=\"Days since Receipt of First Dose\", main=c(\"Specified knots: \",paste(round(tvec.in,1), collapse=\", \")), xlim=range(time))  ##set alpha.vec here to plot different conditionals alpha.vec <- c(0.4,0.7,0.99)  ## now plot for(i in 1:length(alpha.vec)){         a.in <- alpha.vec[i]     plac.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = 1/a.in,                          frailty = FRAILTY)  vacc.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = 1/a.in,                          frailty = FRAILTY)    lines(time.haz, 1-vacc.haz/plac.haz, col=COL[i],lty=LTY[i],lwd=LWD[i])  abline(v=tvec.in, lty=2, col=\"grey\")  } legend(\"bottomright\",legend=paste0(\"alpha=\",alpha.vec),lty=LTY,lwd=LWD,col=COL)"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay.html","id":"psalphaalpha0-positive-stable-frailty-example","dir":"Articles","previous_headings":"","what":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example","title":"Fay et al. (2025) supporting materials","text":"FαF_{\\alpha}, marginalized piecewise Weibull CDF: Fα(x)=1−exp[−expαη]F_{\\alpha}(x) = 1-\\exp[-\\exp\\alpha\\eta] CDF result integrating piecewise weibull frailty model frailty PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty density: fui(ui|α)=−1πui∑k=1∞Γ(kα+1)k!(−ui−α)ksin(αkπ)f_{u_{}}(u_{} | \\alpha) =  - \\frac{1}{\\pi u_{}}  \\sum_{k=1}^\\infty \\frac{\\Gamma(k \\alpha +1)}{k!}  (-u_{}^{-\\alpha})^k \\sin{(\\alpha k \\pi)} analyze data looks similar Figure 2 Thomas et al (2021) Safety Efficacy BNT162b2 mRNA Covid-19 Vaccine 6 Months.  Set h_parm frailty distribution example. Beware H_PARM different bounds depending value FRAILTY selected. example, going estimate marginal parameters first can accomplish mitigating effect alpha, , setting global variable H_PARM=1.00 passed argument h_parm. first consider two knots allow us model curve three pieces. set first piece group equal can get HR 1 (subsequent sections). first piece can specified short time range groups considered equal due ramp-time vaccine. set ramp-time end 1 day first dose, second piece go 28 days first dose, third piece 56 days first dose, etc.","code":"library(mpw) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  ## plot the data points,  ## with interpolated lines plot  (time, F0, type=\"l\", col=\"black\", xlab=\"Days\", ylab=\"CDF\", lty=2) points(time, F0, col=\"black\", pch=15) lines (time, F1, col=\"blue\", lty=2) points(time, F1, col=\"blue\", pch=16) legend(\"topleft\", c(\"Placebo\", \"Vaccine\"),        col=c(\"black\",\"blue\"),        lty=1,        pch=c(15,16) ) H_PARM <- 1.00 FRAILTY <- \"PS\""},{"path":"https://swihart.github.io/mpw/articles/wwps-fay.html","id":"knot-selection","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example","what":"Knot selection","title":"Fay et al. (2025) supporting materials","text":"","code":"tvec.in<- c(1,28,56,84,112,140,168) tvec.in #> [1]   1  28  56  84 112 140 168"},{"path":[]},{"path":"https://swihart.github.io/mpw/articles/wwps-fay.html","id":"fit-for-placebo-group","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection > Two step fitting procedure","what":"1. Fit for placebo group","title":"Fay et al. (2025) supporting materials","text":"","code":"fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F0)^2) }  init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in))) plac_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_alpha) #> $par #> [1]  0.1602199 -9.4498573  0.1816194 -0.6323941  1.1084249 -0.6612064  0.5807145 #> [8] -0.8614969  0.2335560 #>  #> $value #> [1] 9.918573e-07 #>  #> $counts #> function gradient  #>      479       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_alpha$par[1] g0p = plac_fit_F_alpha$par[2] delta_vec_p =plac_fit_F_alpha$par[-1*c(1,2)]"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay.html","id":"fit-for-vaccine-group","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection > Two step fitting procedure","what":"2. Fit for vaccine group","title":"Fay et al. (2025) supporting materials","text":"Now take logk0p g0p, parameters control first (leftmost) piece placebo group use logk0v g0v estimating pieces vaccine group. forces first pieces groups (.e. ramp-time).","code":"fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=logk0p,                                              g0=g0p,                                              delta_vec=x,                                             h_parm = H_PARM,                                             frailty=FRAILTY)  - F1)^2) }  init.vals <- rep( 0,length(tvec.in)) vacc_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(vacc_fit_F_alpha) #> $par #> [1] -0.18224579 -0.82329339  0.23464110  1.05260310  0.01773164 -0.06979188 #> [7] -0.30021721 #>  #> $value #> [1] 6.401134e-08 #>  #> $counts #> function gradient  #>      436       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0v = logk0p g0v = g0p delta_vec_v =vacc_fit_F_alpha$par"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay.html","id":"plot-population-avg-cdf","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection","what":"Plot population avg CDF","title":"Fay et al. (2025) supporting materials","text":"Quick check fit use knots original time time.dist quick check fit. put vertical dashed lines plot denote knot placement.  Note Days 0 1 curves . range HR 1. Additionally, fit looks okay – points line .","code":"COL <- c(\"black\",\"grey\") LTY <- c(1,1) LWD <- c(2,6) plot(NA,NA,, type=\"l\", col=\"black\", lwd=2, ylim=c(0,0.08), ylab=\"Cumulative Incidence\",xlab=\"Day since Receipt of First Dose\",          main=c(\"Specified Knots: \",paste(round(tvec.in,1), collapse=\", \")), xlim=range(time))  time.dist <- sort(c(seq(min(c(time, tvec.in)),                          max(c(time, tvec.in)), 0.1),                     tvec.in)                   )   plac.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.dist <- popavg_dist(      x = time.dist,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)      lines(c(0,time.dist), c(0,vacc.dist),  col=COL[2],lty=LTY[2],lwd=LWD[2])    points(time, F1, col=\"blue\") abline(v=tvec.in, lty=2, col=\"grey\")  points(time, F0, col=\"black\")    lines(c(0,time.dist), c(0,plac.dist),  col=COL[1],lty=LTY[1],lwd=LWD[1]) legend(\"topleft\",legend=c(expression(F[0](t)),expression(F[1](t))),col=COL,        lty=LTY,lwd=LWD)"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay.html","id":"plot-population-avg-hr","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection","what":"Plot population avg HR","title":"Fay et al. (2025) supporting materials","text":"uses parameters two step fitting procedure HR(0) = 1 use parameters previous fits estimate population average hazard, can fit mpw::popavg_haz(). adjust time input first element just 0.  , plot VE = 1-HR:","code":"time.haz <- c(1e-4, time.dist[-1]) plac.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = H_PARM,                          frailty = FRAILTY)  vacc.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = H_PARM,                          frailty = FRAILTY)  plot  (time.haz, vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Hazard Ratio\", lwd=2, ylim=c(-0.05,1.05))  abline(v=tvec.in, lty=2, col=\"grey\")  axis(1, at=c(tvec.in[1])) plot  (time.haz, 1-vacc.haz/plac.haz, type=\"l\", col=\"purple\", xlab=\"Days\",        ylab=\"Vaccine Efficacy\", lwd=2, ylim=c(-0.05,1.05))  abline(v=tvec.in, lty=2, col=\"grey\")  axis(1, at=c(tvec.in[1]))"},{"path":"https://swihart.github.io/mpw/articles/wwps-fay.html","id":"plot-subject-specific-ves-for-different-alpha-values","dir":"Articles","previous_headings":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Frailty Example > Knot selection","what":"Plot subject-specific VEs for different α\\alpha values","title":"Fay et al. (2025) supporting materials","text":"flatten articles website demonstrating mpw use cases, adding subject specific curves involves mpw::subjspec_haz() function. 1α\\frac{1}{\\alpha} approach, instead use mpw::popavg_haz() specifying h_parm 1/alpha plot subject specific curve. demonstrate individual-level VE might different population-level, code runs loop three specific values alpha:  plot shows positive-stable frailty, α\\alpha goes 0 subject-specific VE flatter, approaching VE=1. α\\alpha goes 1 VE individual approaches population. Conceptually, one might conclude VE waning time alpha 0.99. One conclude alpha 0.40. instances, population-level VE observed. Therefore takeaway make statements VE looking population-level curves.","code":"COL<- gray(c(0.7,.5,0)) LTY<-c(1,2,3) LWD<-c(6,4,2)  plot(NA,NA,, type=\"l\", col=\"black\", lwd=2, ylim=c(0,1), ylab=expression(VE[h]),xlab=\"Days since Receipt of First Dose\", main=c(\"Specified knots: \",paste(round(tvec.in,1), collapse=\", \")), xlim=range(time))  ##set alpha.vec here to plot different conditionals alpha.vec <- c(0.4,0.7,0.99)  ## now plot for(i in 1:length(alpha.vec)){         a.in <- alpha.vec[i]     plac.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0p,                               g0 = g0p,                        delta_vec = delta_vec_p,                           h_parm = 1/a.in,                          frailty = FRAILTY)  vacc.haz <- popavg_haz(      x = time.haz,                             knots = tvec.in,                            logk0 = logk0v,                               g0 = g0v,                        delta_vec = delta_vec_v,                           h_parm = 1/a.in,                          frailty = FRAILTY)    lines(time.haz, 1-vacc.haz/plac.haz, col=COL[i],lty=LTY[i],lwd=LWD[i])  abline(v=tvec.in, lty=2, col=\"grey\")  } legend(\"bottomright\",legend=paste0(\"alpha=\",alpha.vec),lty=LTY,lwd=LWD,col=COL)"},{"path":"https://swihart.github.io/mpw/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"Bruce Swihart. Author, maintainer.","code":""},{"path":"https://swihart.github.io/mpw/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"Swihart B (2025). mpw: Marginalized Piecewise Weibull Frailty Models R. R package version 0.0.0.9000, https://swihart.github.io/mpw/.","code":"@Manual{,   title = {mpw: Marginalized Piecewise Weibull Frailty Models in R},   author = {Bruce Swihart},   year = {2025},   note = {R package version 0.0.0.9000},   url = {https://swihart.github.io/mpw/}, }"},{"path":"https://swihart.github.io/mpw/index.html","id":"mpw-marginalized-piecewise-weibull-frailty-models-in-r","dir":"","previous_headings":"","what":"Marginalized Piecewise Weibull Frailty Models in R","title":"Marginalized Piecewise Weibull Frailty Models in R","text":"goal mpw facilitate estimating Marginalized Piecewise Weibull Frailty Models R.","code":""},{"path":"https://swihart.github.io/mpw/index.html","id":"installation","dir":"","previous_headings":"","what":"Installation","title":"Marginalized Piecewise Weibull Frailty Models in R","text":"can install development version mpw GitHub repo package :","code":"# install.packages(\"pak\") pak::pak(\"swihart/mpw\")"},{"path":"https://swihart.github.io/mpw/index.html","id":"examples","dir":"","previous_headings":"","what":"Examples","title":"Marginalized Piecewise Weibull Frailty Models in R","text":"articles package webpage (https://swihart.github.io/mpw/) work examples Marginalized Piecewise Weibull Frailty Models R. Please consult following articles: Weibull-Weibull-Positive Stable Burr-Weibull-Gamma Marginalized-Weibull-Inverse Gaussian Marginalized-Weibull-Two Point (fixed mean 1) Marginalized-Weibull-Two Point (unconstrained mean) follows basic function calls one group. articles show work-flow calculating plotting population-average subject-specific hazard ratios (HRs) comparing two groups.","code":""},{"path":"https://swihart.github.io/mpw/index.html","id":"psalphaalpha0-positive-stable-example","dir":"","previous_headings":"","what":"PS(α,α,0\\alpha,\\alpha,0) Positive Stable Example","title":"Marginalized Piecewise Weibull Frailty Models in R","text":"FαF_{\\alpha} referenced manuscript.","code":"library(mpw) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  tvec.in <- c(7, seq(14,max(time)-14,length.out=14),max(time)-7) init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in)))   ## fit F_alpha for a given H_PARM H_PARM <- 0.72 fit_F_alpha <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=\"PS\")  - F0)^2) }   plac_fit_F_alpha <-    optim(init.vals, fit_F_alpha,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_alpha) #> $par #>  [1]  -0.15799938 -10.12040145  -0.21508909   0.74768428   0.21589618 #>  [6]   0.03136962  -0.15528469   0.27388947   0.35359469   0.20431276 #> [11]  -0.03848921  -0.39518830   0.11877485  -0.05979150  -0.91393283 #> [16]  -0.27749430   0.54807831   1.84013113 #>  #> $value #> [1] 1.831274e-07 #>  #> $counts #> function gradient  #>     1239       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_alpha$par[1] g0p = plac_fit_F_alpha$par[2] delta_vec_p =plac_fit_F_alpha$par[-1*c(1,2)]    plot(time,       popavg_dist(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm= H_PARM, frailty=\"PS\"),      type=\"l\") points(time, F0) ## plot the pop-avg (marginal) hazard: plot(time,      popavg_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm= H_PARM,                                             frailty=\"PS\"),      type=\"l\", ylim=c(0,1e-3))  ## plot the subject-specific hazard, fit in the presence ## of the h_parm value:  lines(time,      subjspec_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p),      lty=2)"},{"path":"https://swihart.github.io/mpw/index.html","id":"gammabetabeta-example","dir":"","previous_headings":"","what":"Gamma(β,β\\beta,\\beta) Example","title":"Marginalized Piecewise Weibull Frailty Models in R","text":"FβF_{\\beta} referenced manuscript.","code":"library(mpw) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  tvec.in <- c(7, seq(14,max(time)-14,length.out=14),max(time)-7) init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in)))  ## fit F_beta for a given H_PARM H_PARM <- 0.72 fit_F_beta <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=\"GA\")  - F0)^2) }   plac_fit_F_beta <-    optim(init.vals, fit_F_beta,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_beta) #> $par #>  [1]   0.502079930 -10.040468476  -0.330061562   0.003865048  -0.336826948 #>  [6]  -0.024383734   0.250173132   0.439016976  -0.255277225  -0.234803012 #> [11]   1.061206688  -0.896795452   0.105126011  -0.138730813  -0.307526058 #> [16]  -0.739420915   1.018565747   1.429820594 #>  #> $value #> [1] 4.750979e-07 #>  #> $counts #> function gradient  #>      999       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_beta$par[1] g0p = plac_fit_F_beta$par[2] delta_vec_p =plac_fit_F_beta$par[-1*c(1,2)]    plot(time,       popavg_dist(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm=H_PARM, frailty=\"GA\"),      type=\"l\") points(time, F0) ## plot the pop-avg (marginal) hazard: plot(time,      popavg_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm= H_PARM, frailty=\"GA\"),      type=\"l\", ylim=c(0,1e-3))  ## plot the subject-specific hazard, fit in the presence ## of the h_parm value:  lines(time,      subjspec_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p),      lty=2)"},{"path":"https://swihart.github.io/mpw/index.html","id":"inverse-gaussian1lambda-example","dir":"","previous_headings":"","what":"Inverse Gaussian(1,λ1,\\lambda) Example","title":"Marginalized Piecewise Weibull Frailty Models in R","text":"FλF_{\\lambda} referenced manuscript. Fλ(x)=1−exp[−λ((1+2λexpη)12−1)]F_{\\lambda}(x) = 1-\\exp[- \\lambda ( (1+ \\frac{2}{\\lambda} \\exp\\eta )^{\\frac{1}{2}} - 1) ]","code":"library(mpw) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  tvec.in <- c(7, seq(14,max(time)-14,length.out=14),max(time)-7) init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in)))   ## fit F_lambda for a given H_PARM H_PARM <- 0.72 fit_F_lambda <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=\"IG\")  - F0)^2) }   plac_fit_F_lambda <-    optim(init.vals, fit_F_lambda,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_lambda) #> $par #>  [1]  0.519049948 -9.963880564 -0.548971978  0.009675958  0.114421179 #>  [6] -0.167680517  0.032601213  0.688049475 -0.746732555  0.412303893 #> [11]  0.728639433 -1.136741731  0.565512220 -0.328530329 -0.491673765 #> [16] -0.139534288  0.275973154  1.104640530 #>  #> $value #> [1] 2.955449e-07 #>  #> $counts #> function gradient  #>     1225       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_lambda$par[1] g0p = plac_fit_F_lambda$par[2] delta_vec_p =plac_fit_F_lambda$par[-1*c(1,2)]    plot(time,       popavg_dist(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm=H_PARM, frailty=\"IG\"),      type=\"l\") points(time, F0) ## plot the pop-avg (marginal) hazard: plot(time,      popavg_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm=H_PARM, frailty=\"IG\"),      type=\"l\", ylim=c(0,1e-3))  ## plot the subject-specific hazard, fit in the presence ## of the h_parm value:  lines(time,      subjspec_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p),      lty=2)"},{"path":"https://swihart.github.io/mpw/index.html","id":"two-pointrho-xi-example","dir":"","previous_headings":"","what":"Two-Point(ρ\\rho, ξ\\xi) Example","title":"Marginalized Piecewise Weibull Frailty Models in R","text":"FρF_{\\rho} referenced manuscript. Fρ(x)=1−((1−ρ)exp[−ξexpη]+ρexp[−ξ′expη])F_{\\rho}(x) =  1-             \\left(           (1-\\rho)  \\exp[- \\xi \\exp\\eta ] + \\rho \\exp[-\\xi^{\\prime} \\exp \\eta ] \\right)","code":"library(mpw) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  tvec.in <- c(7, seq(14,max(time)-14,length.out=14),max(time)-7) init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in)))  ## fit F_rho for a given H_PARM and XI <1 ## (1-H_PARM) will have value XI < 1 ##    H_PARM  will have XI_prime > 1 that ensures E[u] = 1 H_PARM <- 0.1 XI <- 1/10 fit_F_rho <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=\"TP1\",                                             xi = XI)  - F0)^2) }   plac_fit_F_rho <-    optim(init.vals, fit_F_rho,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_rho) #> $par #>  [1]  0.504788613 -9.907296470 -0.306067147 -0.209186119 -0.145926847 #>  [6] -0.254946042  0.822243872  0.007185863  0.087754729  0.002753200 #> [11]  0.214539410  0.111070205 -0.516003004  0.469736272 -1.126555327 #> [16]  0.332635368  0.617509128  0.509920955 #>  #> $value #> [1] 2.793263e-07 #>  #> $counts #> function gradient  #>     1111       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_rho$par[1] g0p = plac_fit_F_rho$par[2] delta_vec_p =plac_fit_F_rho$par[-1*c(1,2)]    plot(time,       popavg_dist(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm=H_PARM,                   frailty=\"TP1\", xi = XI),      type=\"l\") points(time, F0) ## plot the pop-avg (marginal) hazard: plot(time,      popavg_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm=H_PARM,                  frailty=\"TP1\", xi=XI),      type=\"l\", ylim=c(0,1e-3))  ## plot the subject-specific hazard, fit in the presence ## of the h_parm value:  lines(time,      subjspec_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p),      lty=2)"},{"path":"https://swihart.github.io/mpw/index.html","id":"two-pointomega-n-s-example","dir":"","previous_headings":"","what":"Two-Point(ω\\omega, nn, ss) Example","title":"Marginalized Piecewise Weibull Frailty Models in R","text":"FωF_{\\omega} referenced manuscript.","code":"library(mpw) ## This data resembles Figure 2 in Thomas et al ## https://pubmed.ncbi.nlm.nih.gov/34525277/ time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196) F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100 F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100  tvec.in <- c(7, seq(14,max(time)-14,length.out=14),max(time)-7) init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in)))  ## fit F_omega for a given H_PARM and N<1 and S>1 ## (1-H_PARM) will have value N < 1 ##    H_PARM  will have value S > 1  H_PARM <- 0.5 N <- 0.25 S <- 4.00 fit_F_omega <- function(x){mean((popavg_dist(time,                                              knots= tvec.in,                                              logk0=x[1],                                              g0=x[2],                                              delta_vec=x[-c(1,2)],                                             h_parm = H_PARM,                                             frailty=\"TPU\",                                             n=N,                                             s=S)  - F0)^2) }   plac_fit_F_omega <-    optim(init.vals, fit_F_omega,         method=\"Nelder-Mead\",         control=list(maxit=1e8)) print(plac_fit_F_omega) #> $par #>  [1]  0.48099077 -9.97182403 -0.91909126  0.05937541  0.33699959 -0.01413072 #>  [7] -0.17026103  0.81246434 -0.14277889 -0.04705732  0.03813736 -0.45175104 #> [13]  1.01934966 -1.27666904  0.08861910 -0.51736433  0.95470678  0.83804581 #>  #> $value #> [1] 3.751629e-07 #>  #> $counts #> function gradient  #>     1035       NA  #>  #> $convergence #> [1] 0 #>  #> $message #> NULL  logk0p = plac_fit_F_omega$par[1] g0p = plac_fit_F_omega$par[2] delta_vec_p =plac_fit_F_omega$par[-1*c(1,2)]    plot(time,       popavg_dist(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm=H_PARM, frailty=\"TPU\",                  n=N, s=S),      type=\"l\") points(time, F0) ## plot the pop-avg (marginal) hazard: plot(time,      popavg_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p, h_parm=H_PARM,                  frailty=\"TPU\", n=0.25, s=4.00),      type=\"l\", ylim=c(0,1e-3))  ## plot the subject-specific hazard, fit in the presence ## of the h_parm value:  lines(time,      subjspec_haz(time, knots=tvec.in, logk0=logk0p, g0=g0p,                   delta_vec = delta_vec_p),      lty=2)"},{"path":"https://swihart.github.io/mpw/reference/ipd_data.html","id":null,"dir":"Reference","previous_headings":"","what":"IPD data from XX — ipd_data","title":"IPD data from XX — ipd_data","text":"IPDfromKM generated dataset based curves tables Figure 2 Thomas et al (2021) Safety Efficacy BNT162b2 mRNA Covid-19 Vaccine 6 Months","code":""},{"path":"https://swihart.github.io/mpw/reference/ipd_data.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"IPD data from XX — ipd_data","text":"","code":"ipd_data"},{"path":[]},{"path":"https://swihart.github.io/mpw/reference/ipd_data.html","id":"ipd-data","dir":"Reference","previous_headings":"","what":"ipd_data","title":"IPD data from XX — ipd_data","text":"data frame 44,939 3 columns: time day since first dose status value 1 occurrence Covid-19 first dose; 0 censored treat value 1 treated; value 0 placebo","code":""},{"path":"https://swihart.github.io/mpw/reference/ipd_data.html","id":"source","dir":"Reference","previous_headings":"","what":"Source","title":"IPD data from XX — ipd_data","text":"https://pubmed.ncbi.nlm.nih.gov/34525277/#&gid=article-figures&pid=figure-2-uid-1","code":""},{"path":"https://swihart.github.io/mpw/reference/popavg_dist.html","id":null,"dir":"Reference","previous_headings":"","what":"Population average distribution function — popavg_dist","title":"Population average distribution function — popavg_dist","text":"Population average distribution function","code":""},{"path":"https://swihart.github.io/mpw/reference/popavg_dist.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Population average distribution function — popavg_dist","text":"","code":"popavg_dist(   x,   knots,   logk0 = -0.1,   g0 = 0.1,   delta_vec,   h_parm = 1,   frailty = \"PS\",   xi = 0.99,   n = 0.99,   s = 1.01 )"},{"path":"https://swihart.github.io/mpw/reference/popavg_dist.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Population average distribution function — popavg_dist","text":"x domain function; survival times. knots vector internal knots change-points. Must within range (min(x), max(x)). logk0 log shape parameter first piece. g0 shape parameter. delta_vec vector delta parameters, order. h_parm heterogeneity parameter homogeneity parameter.  decide h stands . frailty character matching \"PS\" positive stable (alpha case paper), \"GA\" gamma (beta), \"IG\" Inverse Gaussian (lambda), \"TP1\" (rho) two point mean 1, \"TPU\" two point unrestricted (omega). xi scalar less 1 frailty=\"TP1\" case. n scalar less 1 frailty=\"TPU\" case. s scalar 1 frailty=\"TPU\" case.","code":""},{"path":"https://swihart.github.io/mpw/reference/popavg_dist.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Population average distribution function — popavg_dist","text":"Value","code":""},{"path":"https://swihart.github.io/mpw/reference/popavg_dist.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Population average distribution function — popavg_dist","text":"","code":"rnorm(1) #> [1] 0.2553171"},{"path":"https://swihart.github.io/mpw/reference/popavg_haz.html","id":null,"dir":"Reference","previous_headings":"","what":"Population average hazard function — popavg_haz","title":"Population average hazard function — popavg_haz","text":"Population average hazard function","code":""},{"path":"https://swihart.github.io/mpw/reference/popavg_haz.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Population average hazard function — popavg_haz","text":"","code":"popavg_haz(   x,   knots,   logk0 = -0.1,   g0 = 0.1,   delta_vec,   h_parm = 1,   frailty = \"PS\",   xi = 0.99,   n = 0.99,   s = 1.01 )"},{"path":"https://swihart.github.io/mpw/reference/popavg_haz.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Population average hazard function — popavg_haz","text":"x domain function; survival times. knots vector internal knots change-points. Must within range (min(x), max(x)). logk0 log shape parameter first piece. g0 shape parameter. delta_vec vector delta parameters, order. h_parm heterogeneity parameter homogeneity parameter.  decide h stands . frailty character matching \"PS\" positive stable (alpha case paper), \"GA\" gamma (beta), \"IG\" Inverse Gaussian (lambda), \"TP1\" (rho) two point mean 1, \"TPU\" two point unrestricted (omega). xi scalar less 1 frailty=\"TP1\" case. n scalar less 1 frailty=\"TPU\" case. s scalar 1 frailty=\"TPU\" case.","code":""},{"path":"https://swihart.github.io/mpw/reference/popavg_haz.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Population average hazard function — popavg_haz","text":"Value","code":""},{"path":"https://swihart.github.io/mpw/reference/popavg_haz.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Population average hazard function — popavg_haz","text":"","code":"rnorm(1) #> [1] -0.005571287"},{"path":"https://swihart.github.io/mpw/reference/subjspec_haz.html","id":null,"dir":"Reference","previous_headings":"","what":"Subject specific hazard function — subjspec_haz","title":"Subject specific hazard function — subjspec_haz","text":"Take parameters estimated popavg_dist calculate subject specific hazards Weibull form b*k*x^(k-1).","code":""},{"path":"https://swihart.github.io/mpw/reference/subjspec_haz.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Subject specific hazard function — subjspec_haz","text":"","code":"subjspec_haz(x, knots, logk0 = -0.1, g0 = 0.1, delta_vec)"},{"path":"https://swihart.github.io/mpw/reference/subjspec_haz.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Subject specific hazard function — subjspec_haz","text":"x domain function; survival times. knots vector internal knots change-points. Must within range (min(x), max(x)). logk0 log shape parameter first piece. g0 shape parameter. delta_vec vector delta parameters, order.","code":""},{"path":"https://swihart.github.io/mpw/reference/subjspec_haz.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Subject specific hazard function — subjspec_haz","text":"Value","code":""},{"path":"https://swihart.github.io/mpw/reference/subjspec_haz.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Subject specific hazard function — subjspec_haz","text":"","code":"rnorm(1) #> [1] 1.148412"}]
