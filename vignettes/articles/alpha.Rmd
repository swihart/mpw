---
title: "Weibull-Weibull-Positive Stable"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r data}
library(mpw)
## This data resembles that in Thomas et al
time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196)
F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100
F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100

## plot the data points, 
## with interpolated lines
plot  (time, F0, type="l", col="black", xlab="Days", ylab="CDF")
points(time, F0, col="black", pch=15)
lines (time, F1, col="blue")
points(time, F1, col="blue", pch=16)
legend("topleft", c("Placebo", "Vaccine"),
       col=c("black","blue"),
       lty=1,
       pch=c(15,16)
)

```

Set the `h_parm` and `frailty` distribution for this example.

```{r setup}
H_PARM <- 0.72
FRAILTY <- "PS"
```
## Two knots

### Two step fitting procedure

#### 1. Fit for placebo group

#### 2. Fit for vaccine group

### Plot population avg CDF
  * Quick check of fit
  
### Plot population avg HR
  * uses parameters from two step fitting procedure
  * HR(0) = 1
  
### Add subject-specific HRs
  * should flatten

## Sixteen knots

```{r knot16_specific_setup}
tvec.in <- c(7, seq(14,max(time)-14,length.out=14),max(time)-7)
init.vals <- c(log(2.4), -10, rep( 0,length(tvec.in)))
```

### Two step fitting procedure

#### 1. Fit for placebo group
```{r }
fit_F_alpha <- function(x){mean((popavg_dist(time, 
                                            knots= tvec.in, 
                                            logk0=x[1], 
                                            g0=x[2], 
                                            delta_vec=x[-c(1,2)],
                                            h_parm = H_PARM,
                                            frailty=FRAILTY)  - F0)^2) }


plac_fit_F_alpha <- 
  optim(init.vals, fit_F_alpha,
        method="Nelder-Mead",
        control=list(maxit=1e8))
print(plac_fit_F_alpha)

logk0p = plac_fit_F_alpha$par[1]
g0p = plac_fit_F_alpha$par[2]
delta_vec_p =plac_fit_F_alpha$par[-1*c(1,2)]
```
#### 2. Fit for vaccine group

### Plot population avg CDF
  * Quick check of fit
  
### Plot population avg HR
  * uses parameters from two step fitting procedure
  * HR(0) = 1
  
### Add subject-specific HRs
  * should flatten

