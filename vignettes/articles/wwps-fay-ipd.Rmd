---
title: "IPD version: Fay et al. (2025) supporting materials"
subtitle: "IPD version"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true
---

In Fay et al. (2025) *Vaccine Efficacy Estimands for Individual Randomized Field Trials*, the $\frac{1}{\alpha}$ approach is used. In this approach which utilizes the "Weibull-Weibull-Positive Stable" model, the population (marginal) Weibull is estimated, and then $\frac{1}{\alpha}$ is applied to those estimates to render the individual-level (conditional) Weibull. This code recreates Figure 6 in that paper using `mpw` calls.

The Weibull-Weibull-Positive Stable has a feature that the other mpw frailty models do not have: that is, the marginal distribution (Weibull) is the same as the conditional distribution (also Weibull).  This enables a strategy of estimating the mpw on the population data without specifying an $\alpha$ (this is done in practice by setting `alpha=1`) and then from there one can exactly calculate corresponding conditional models (and HRs, and VEs, etc) using $\frac{1}{\alpha}$ applied to the *marginal* $b$ and $k$ estimates. 

Explicitly, the hazard ratio for an individual, $\theta_I$, can be produced by:

$$\frac{ b_1^{1/\alpha} (k_1/\alpha) t^{(k_1/\alpha)-1}}{b_0^{1/\alpha} (k_0/\alpha) t^{(k_0/\alpha)-1}} = \theta_I$$

More details for the interested reader can be found in
[Swihart & Bandyopadhyay (2021)](https://www.sciencedirect.com/science/article/pii/S0169260721001905?casa_token=xYzQZ9UfxGMAAAAA:vFpj08P43bUx_7BTN21cSUksK_WSyQdjIBhWHS7VG8u5ctGB91gDzE8-NJtMblcut67jD6k), particularly in Section 2.1.  


# PS($\alpha,\alpha,0$) Positive Stable Frailty Example

This is the $F_{\alpha}$, the marginalized piecewise Weibull CDF:

  * $F_{\alpha}(x) = 1-\exp[-\exp\alpha\eta]$

The CDF above is the result of integrating a piecewise weibull frailty model where the frailty has the PS($\alpha,\alpha,0$) Positive Stable Frailty density:

  * $f_{u_{i}}(u_{i} | \alpha) =  - \frac{1}{\pi u_{i}}  \sum_{k=1}^\infty \frac{\Gamma(k \alpha +1)}{k!}  (-u_{i}^{-\alpha})^k \sin{(\alpha k \pi)}$
  
  
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# IPD data from a KM curve

We analyze data that looks similar to that of Figure 2 [Thomas et al (2021) *Safety and Efficacy of the BNT162b2 mRNA Covid-19 Vaccine through 6 Months*](https://pubmed.ncbi.nlm.nih.gov/34525277/). 

We accomplished creating the dataset in this package, `ipd_data`, by using the R package `IPDfromKM`.  Feeding screen shots of the original Figure 2 (rotated and flipped so that they looked like survival curves) into `IPDfromKM`, and then using the point and click feature for both inset curve and full curve for each group.  The results of this data are saved as `ipd_data` in this package (mpw) and can be loaded and analyzed, just as we do in this document.

Below, we load `ipd_data` and do a couple of quick checks with `survminer` before proceeding with the core of our example.

<!-- We plot the data points, color-code the groups, and just connect the dots with interpolated, dashed lines. -->
```{r, eval=TRUE,include=FALSE}
ipd_plac <- NULL
ipd_plac$Points <- 
  structure(list(time = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 
12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 24, 25, 26, 27, 28, 
28, 30, 32, 34, 35, 37, 38, 39, 41, 42, 44, 48, 50, 52, 55, 59, 
61, 64, 66, 69, 72, 75, 77, 80, 82, 85, 88, 89, 91, 92, 93, 95, 
96, 97, 99, 101, 103, 103, 105, 107, 108, 109, 111, 113, 115, 
118, 119, 122, 124, 129, 130, 132, 134, 136, 138, 140, 143, 145, 
147, 148, 152, 153, 154, 155, 157, 160, 161, 162, 163, 166, 168, 
171, 172, 175, 177, 182, 183, 188, 188, 189, 193), surv = c(1, 
0.999923986486487, 0.9996875, 0.99945945945946, 0.999239864864865, 
0.99897804054054, 0.998809121621622, 0.998623310810811, 0.998327702702703, 
0.998141891891892, 0.997964527027027, 0.997787162162162, 0.997592905405405, 
0.997052364864865, 0.996883445945946, 0.996646959459459, 0.9965625, 
0.996359797297297, 0.996089527027027, 0.99585304054054, 0.995684121621622, 
0.995574324324324, 0.995295608108108, 0.994503816793893, 0.994198473282443, 
0.993893129770992, 0.993587786259542, 0.993435114503817, 0.993129770992366, 
0.992671755725191, 0.99236641221374, 0.991908396946565, 0.991603053435114, 
0.991297709923664, 0.990687022900763, 0.990229007633588, 0.990076335877863, 
0.989770992366412, 0.989465648854962, 0.988549618320611, 0.987786259541985, 
0.986717557251908, 0.985801526717557, 0.985038167938931, 0.98412213740458, 
0.983358778625954, 0.982900763358779, 0.981832061068702, 0.980763358778626, 
0.980152671755725, 0.97969465648855, 0.978320610687023, 0.977099236641221, 
0.975725190839695, 0.974503816793893, 0.973740458015267, 0.973587786259542, 
0.972519083969466, 0.972213740458015, 0.971297709923664, 0.970839694656488, 
0.970687022900763, 0.970534351145038, 0.969160305343511, 0.969160305343511, 
0.967480916030534, 0.967328244274809, 0.966412213740458, 0.965801526717557, 
0.964732824427481, 0.964274809160305, 0.963206106870229, 0.962442748091603, 
0.962137404580153, 0.960916030534351, 0.959541984732824, 0.958778625954198, 
0.955725190839695, 0.954351145038168, 0.954045801526717, 0.952977099236641, 
0.952213740458015, 0.950992366412214, 0.950229007633588, 0.949770992366412, 
0.948702290076336, 0.948091603053435, 0.946870229007634, 0.945954198473282, 
0.945190839694656, 0.94442748091603, 0.943969465648855, 0.943664122137404, 
0.943206106870229, 0.942442748091603, 0.941984732824427, 0.941526717557252, 
0.940916030534351, 0.94, 0.938931297709924, 0.937862595419847, 
0.937862595419847, 0.936946564885496, 0.936335877862595, 0.935725190839695, 
0.935419847328244, 0.934656488549618, 0.933435114503817, 0.93236641221374
), id = 1:109, interval = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 
4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 
5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 
5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 
6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6), risk = c(22434, 22433, 
22429, 22422, 22415, 22408, 22400, 22394, 22388, 22379, 22373, 
22369, 22336, 22303, 22262, 22229, 22194, 22163, 22130, 22095, 
22060, 22057, 22053, 22044, 22024, 22016, 22008, 22001, 21998, 
21940, 21879, 21821, 21785, 21727, 21696, 21656, 21595, 21566, 
21508, 21400, 21328, 21260, 21160, 21039, 20971, 20875, 20808, 
20721, 20622, 20522, 20458, 20373, 20344, 19902, 19456, 19291, 
18998, 18856, 18696, 18412, 18254, 18107, 17826, 17544, 17240, 
17240, 16932, 16651, 16496, 16347, 16049, 15763, 15467, 15037, 
14893, 14456, 14157, 13449, 13267, 12970, 12686, 12394, 12105, 
11812, 11802, 11730, 11649, 11608, 11459, 11414, 11371, 11328, 
11256, 11151, 11112, 11069, 11031, 10924, 10850, 10739, 10692, 
10579, 10512, 10334, 10293, 10118, 10115, 10073, 9927), censor = c(1, 
2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 29, 29, 29, 29, 30, 29, 29, 29, 
29, 0, 1, 3, 2, 2, 1, 0, 0, 51, 51, 51, 26, 51, 25, 26, 51, 26, 
51, 102, 52, 51, 77, 102, 51, 77, 51, 77, 77, 77, 51, 76, 0, 
417, 418, 140, 278, 139, 140, 278, 140, 139, 278, 279, 279, 0, 
278, 279, 139, 139, 279, 279, 278, 418, 139, 418, 279, 696, 140, 
278, 279, 278, 279, 278, 0, 67, 67, 34, 134, 34, 34, 33, 67, 
101, 34, 34, 33, 101, 67, 101, 34, 101, 67, 168, 34, 168, 0, 
34, 133, 0), event = c(0, 2, 5, 5, 5, 6, 4, 4, 7, 4, 4, 4, 4, 
12, 4, 5, 2, 4, 6, 6, 3, 3, 6, 18, 6, 7, 7, 3, 7, 10, 7, 10, 
7, 6, 14, 10, 3, 7, 6, 20, 17, 23, 19, 17, 19, 16, 10, 22, 23, 
13, 9, 29, 25, 28, 25, 15, 3, 20, 6, 18, 8, 3, 3, 25, 0, 30, 
2, 16, 10, 19, 7, 18, 12, 5, 19, 20, 12, 42, 19, 5, 14, 10, 15, 
10, 5, 14, 7, 15, 11, 9, 10, 5, 4, 5, 9, 5, 6, 7, 10, 13, 12, 
0, 10, 7, 7, 3, 8, 13, 12), estsurv = c(1, 1, 1, 0.999, 0.999, 
0.999, 0.999, 0.999, 0.998, 0.998, 0.998, 0.998, 0.998, 0.997, 
0.997, 0.997, 0.997, 0.996, 0.996, 0.996, 0.996, 0.996, 0.995, 
0.994, 0.994, 0.994, 0.994, 0.993, 0.993, 0.993, 0.992, 0.992, 
0.992, 0.991, 0.991, 0.99, 0.99, 0.99, 0.989, 0.989, 0.988, 0.987, 
0.986, 0.985, 0.984, 0.983, 0.983, 0.982, 0.981, 0.98, 0.98, 
0.978, 0.977, 0.976, 0.974, 0.974, 0.974, 0.973, 0.972, 0.971, 
0.971, 0.971, 0.971, 0.969, 0.967, 0.967, 0.967, 0.966, 0.966, 
0.965, 0.964, 0.963, 0.962, 0.962, 0.961, 0.96, 0.959, 0.956, 
0.954, 0.954, 0.953, 0.952, 0.951, 0.95, 0.95, 0.949, 0.948, 
0.947, 0.946, 0.945, 0.944, 0.944, 0.944, 0.943, 0.942, 0.942, 
0.942, 0.941, 0.94, 0.939, 0.938, 0.938, 0.937, 0.936, 0.936, 
0.935, 0.935, 0.933, 0.932), diff = c(0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.001, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, -0.001, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.002, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0)), row.names = c(NA, 109L), class = "data.frame")
```

```{r, eval=TRUE,include=FALSE}
ipd_vacc <- NULL
ipd_vacc$Points <- 
  structure(list(time = c(0, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 
14, 17, 18, 25, 27, 34, 42, 47, 51, 53, 57, 60, 64, 68, 73, 77, 
83, 86, 88, 90, 94, 95, 98, 101, 105, 108, 114, 115, 116, 119, 
121, 124, 127, 129, 130, 131, 133, 136, 138, 139, 143, 146, 152, 
154, 154, 158, 162, 166, 180, 181), surv = c(1, 0.999704391891892, 
0.999619932432432, 0.999543918918919, 0.999358108108108, 0.999138513513514, 
0.998868243243243, 0.998597972972973, 0.998412162162162, 0.998285472972973, 
0.998201013513514, 0.998158783783784, 0.998108108108108, 0.998065878378378, 
0.998015202702703, 0.997701149425287, 0.997547892720307, 0.997547892720307, 
0.997547892720307, 0.997547892720307, 0.997547892720307, 0.997394636015326, 
0.997394636015326, 0.997241379310345, 0.997088122605364, 0.997088122605364, 
0.997088122605364, 0.996934865900383, 0.996781609195402, 0.996628352490421, 
0.996628352490421, 0.996475095785441, 0.996475095785441, 0.99632183908046, 
0.99632183908046, 0.99632183908046, 0.996015325670498, 0.995862068965517, 
0.995862068965517, 0.995555555555555, 0.995402298850575, 0.995402298850575, 
0.995095785440613, 0.994789272030651, 0.99463601532567, 0.99463601532567, 
0.99463601532567, 0.99463601532567, 0.994329501915709, 0.993716475095785, 
0.993716475095785, 0.993716475095785, 0.993256704980843, 0.993256704980843, 
0.993256704980843, 0.993256704980843, 0.9927969348659, 0.992490421455939, 
0.992337164750958, 0.992183908045977, 0.991724137931034, 0.991570881226054
), id = 1:62, interval = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 
2, 2, 2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 
5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 
6, 6, 6, 6, 6, 6, 6, 6), risk = c(22505, 22492, 22478, 22469, 
22462, 22451, 22439, 22426, 22412, 22402, 22399, 22333, 22299, 
22199, 22165, 22163, 22135, 22132, 21890, 21738, 21616, 21555, 
21431, 21340, 21214, 21090, 20938, 20817, 20814, 20378, 20086, 
19797, 19216, 19071, 18634, 18201, 17623, 17183, 16314, 16169, 
16020, 15583, 15294, 14857, 14418, 14127, 13982, 13838, 13549, 
13111, 12814, 12670, 12670, 12562, 12357, 12289, 12289, 12147, 
12006, 11868, 11389, 11350), censor = c(13, 7, 7, 6, 7, 7, 7, 
7, 6, 0, 65, 33, 99, 33, 0, 21, 0, 242, 152, 122, 61, 121, 91, 
122, 121, 152, 121, 0, 433, 289, 289, 578, 145, 434, 433, 578, 
434, 867, 145, 144, 434, 289, 433, 434, 289, 145, 144, 289, 434, 
289, 144, 0, 102, 205, 68, 0, 136, 137, 136, 478, 33, 0), event = c(0, 
7, 2, 1, 4, 5, 6, 7, 4, 3, 1, 1, 1, 1, 2, 7, 3, 0, 0, 0, 0, 3, 
0, 4, 3, 0, 0, 3, 3, 3, 0, 3, 0, 3, 0, 0, 6, 2, 0, 5, 3, 0, 4, 
5, 2, 0, 0, 0, 4, 8, 0, 0, 6, 0, 0, 0, 6, 4, 2, 1, 6, 1), estsurv = c(1, 
1, 1, 1, 0.999, 0.999, 0.999, 0.999, 0.998, 0.998, 0.998, 0.998, 
0.998, 0.998, 0.998, 0.998, 0.998, 0.998, 0.998, 0.998, 0.998, 
0.997, 0.997, 0.997, 0.997, 0.997, 0.997, 0.997, 0.997, 0.997, 
0.997, 0.996, 0.996, 0.996, 0.996, 0.996, 0.996, 0.996, 0.996, 
0.996, 0.995, 0.995, 0.995, 0.995, 0.995, 0.995, 0.995, 0.995, 
0.994, 0.994, 0.994, 0.994, 0.993, 0.993, 0.993, 0.993, 0.993, 
0.992, 0.992, 0.992, 0.992, 0.992), diff = c(0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)), row.names = c(NA, 
62L), class = "data.frame")
```


```{r thomas-data, warning=FALSE, message=FALSE}
library(survminer)
library(survival)
library(mpw)

## This data resembles Figure 2 in Thomas et al
## https://pubmed.ncbi.nlm.nih.gov/34525277/
data(ipd_data)
dim(ipd_data)
head(ipd_data)

fit <- survfit(Surv(time, status) ~ treat,
               data = ipd_data)
## zoomed in, inset, 11days
# Visualize with survminer
ggsurvplot(fit, data = ipd_data, risk.table = TRUE, 
           ylim=c(1,0.993), xlim=c(0,28), break.time.by=11,
           fontsize=2.7,tables.height = 0.350,
           legend.labs = c("Placebo", "BNT162b2"),
           palette = c("#2E9FDF","#FF4500" ))

# Visualize with survminer
## full view; every 14 days
ggsurvplot(fit, data = ipd_data, risk.table = TRUE, 
           ylim=c(1,0.925), break.time.by=14,
           fontsize=2.7, tables.height = 0.350,
           legend.labs = c("Placebo", "BNT162b2"),
           palette = c("#2E9FDF","#FF4500" ))
```

```{r, include=FALSE,eval=FALSE}
# time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196)
# F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100
# F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100

## plot the data points, 
## with interpolated lines
# plot  (time, F0, type="l", col="black", xlab="Days", ylab="CDF", lty=2)
# points(time, F0, col="black", pch=15)
# lines (time, F1, col="#FF4500", lty=2)
# points(time, F1, col="#FF4500", pch=16)
# legend("topleft", c("Placebo", "Vaccine"),
#        col=c("black","#FF4500"),
#        lty=1,
#        pch=c(15,16)
# )

```

Set the `h_parm` and `frailty` distribution for this example. Beware that H_PARM has different bounds depending on what value of FRAILTY is selected.
For this example, we are going to estimate the marginal parameters first and can accomplish this by mitigating the effect of alpha, that is, setting the global variable `H_PARM=1.00` which will be passed to the argument `h_parm`.

```{r setup}
ALPHA_FIXED <- H_PARM <- 1.00
FRAILTY <- "PS"
```

We set the first piece of each group to be equal so we can get an HR of 1 (more in subsequent sections). This first piece can be specified to be over a short time range where both groups would be considered equal due to the *ramp-up time* of a vaccine.  Below we set the ramp-up time to end 1 day after first dose, the second piece to go from then to 28 days after the first dose, and the third piece from then 56 days after the first dose, etc.  The pieces are determined by the knots, which we select in the next section to match up with the periods of time listed in the Figure 2 of Thomas et al(2020).


# Knot selection
```{r knot02-specific-setup}
tvec.in<- c(1,28,56,84,112,140,168)
tvec.in
```


# Fit the Likelihood to IPD data

We set up some global variables from the data:

```{r}
library(data.table)
## the approach this script uses to build the likelihood
## uses data.table
data.table::setDT(ipd_data)

ipd_data$id <- 1:NROW(ipd_data)
time <- ipd_data$time
status <- ipd_data$status
treat <- ipd_data$treat
one_minus_treat <- 1-treat

## print the tvec.in (knots) selected:
tvec.in
LTVEC <- length(tvec.in)
LTVEC
```


This is the likelihood that can be optimized using IPD data. This approach is similar to Swihart & Bandyopadhyay (2021).

```{r}
## this approach is similar to Swihart & Bandyopadhyay 2021
integrated_likelihood <- function(parms){
  
  logk0  <- parms[ 1]; # shared shape (piece 1)
  g0  <- parms[ 2]; # shared scale (piece 1)
  delta_p <- parms[ 3:(3+(LTVEC-1))];
  
  delta_v <- parms[ (3+LTVEC):(2*LTVEC+2)];
  
  ## use fast data.table to only compute if needed
  ipd_data[, haz_p :=
             ifelse(status==1 & treat==0, 
                    
                    popavg_haz(      x = time, 
                                     knots = tvec.in,
                                     logk0 = logk0,
                                     g0 = g0,
                                     delta_vec = delta_p,
                                     h_parm = ALPHA_FIXED,
                                     frailty = "PS"),
                    1),
           by=id
  ]
  
  ipd_data[, haz_v :=
             ifelse(status==1 & treat==1, 
                    
                    popavg_haz(      x = time,
                                     knots = tvec.in,
                                     logk0 = logk0,
                                     g0 = g0,
                                     delta_vec = delta_v,
                                     h_parm = ALPHA_FIXED,
                                     frailty = "PS"),
                    1),
           by=id
  ]
  
  ipd_data[, surv_p :=
             ifelse(treat==0, 
                    
                    (1-popavg_dist(      x = time, 
                                         knots = tvec.in,
                                         logk0 = logk0,
                                         g0 = g0,
                                         delta_vec = delta_p,
                                         h_parm = ALPHA_FIXED,
                                         frailty = "PS")),
                    1),
           by=id
  ]
  
  
  ipd_data[, surv_v :=
             ifelse(treat==1, 
                    
                    (1-popavg_dist(      x = time, 
                                         knots = tvec.in,
                                         logk0 = logk0,
                                         g0 = g0,
                                         delta_vec = delta_v,
                                         h_parm = ALPHA_FIXED,
                                         frailty = "PS")),
                    1),
           by=id
  ]
  
  
  ipd_data[, likelihood_contribution:=surv_p*haz_p*surv_v*haz_v]
  k0 = exp(logk0);
  nll <- 
    -sum(
      log(
        ipd_data$likelihood_contribution
      )
    ) + 
    ## penalize shapes less than 0 
    any(c(k0,
          k0+cumsum(delta_p),
          k0+cumsum(delta_v)
    ) < 0) * 1e6
  ## penalize shapes less than 0 
  # sum(abs(c(k0,
  #   k0+cumsum(delta_p),
  #   k0+cumsum(delta_v)
  # )[c(k0,
  #   k0+cumsum(delta_p),
  #   k0+cumsum(delta_v)
  # ) < 0])) 
  
  
  #print(head(ipd_data))
  nll      
}

```

# set starting values and test one evaluation of likelihood

```{r}

## set the starting values for the optimization
## the first two elements are for the first
## (shared) piece; the 2nd row for the 
## deltas for one group
## the 3rd row deltas for the other

start_parms_val <- c(
  0.6, -9.6, ## first piece (shared)
  rep(0.01, LTVEC),
  rep(0.0, LTVEC)
)


## test how long a computation of likelihood takes at starting values
## one compuation?  takes a minute...
beg.one.iter <- Sys.time()
ilspv <- integrated_likelihood(start_parms_val)
ilspv
end.one.iter <- Sys.time()
dur.one.iter <- end.one.iter - beg.one.iter
dur.one.iter
```

We include this code chunk below but do not run it (we saved its output, accessed in the following chunk).  We take the resultant estimates from the `$par` to demonstrate our point.

```{r, include=TRUE, eval=FALSE}

## takes  7 min. w/o hess 
## takes 21 min with hess
hess.true <- FALSE ## calculate hessian (adds time)
cis.true <-  FALSE ## given hess.true is TRUE, invert and calc CIs
beg.all.iter <- Sys.time()
paste0("Started at: ", beg.all.iter)
estimates_from_integrated_likelihood <-
  optim(start_parms_val,
        integrated_likelihood,
        method="Nelder-Mead",
        control=list(maxit=5000, trace=99, reltol=1e-5),
        hessian = hess.true
  )
end.all.iter <- Sys.time()
dur.all.iter <- end.all.iter - beg.all.iter
dur.all.iter
```

<!-- Here's the saved object: -->

```{r, include=FALSE,eval=TRUE}
## > dput(estimates_from_integrated_likelihood)
estimates_from_integrated_likelihood <-
list(par = c(0.152353295766645, -9.29170555007139, 0.106891433620299, 
-0.136059602259565, 0.168511532499485, 0.215710900101426, -0.0812718060180775, 
-0.315370884660848, -0.236712547663703, -0.207309280434875, -0.867076653923816, 
0.418596286367761, 0.318719583458342, 0.561423073791174, 0.264441255322591, 
0.504041894544567), value = 11743.5557393676, counts = c(`function` = 585L, 
gradient = NA), convergence = 0L, message = NULL, hessian = structure(c(46726.4228941531, 
7588.91415762264, 35489.1029558075, 12729.8868162598, 7887.03743114638, 
5037.04853463205, 3088.04326050449, 1741.54023261508, 746.805569178832, 
4620.23907903131, 1915.53882314111, 940.026757234591, 566.068177704437, 
324.305618050857, 159.556260769023, 43.6977356912394, 7588.91415762264, 
1284.10950310354, 5837.30741664112, 2007.53645276563, 1213.98571127429, 
754.938053205478, 449.127310730546, 245.601941514906, 101.32384386452, 
679.144186960912, 230.875468787417, 138.203271944803, 84.8153354127135, 
49.0339689349639, 24.7462162406009, 6.92689218340092, 35489.1029558075, 
5837.30741664112, 30473.811164029, 10930.9099361781, 6772.44860253268, 
4325.21308266587, 2651.63563562965, 1495.42477038267, 641.267406535917, 
0, 0, 0, 0, 0, 0, 0, 12729.8868162598, 2007.53645276563, 10930.9099361781, 
4241.34615741423, 2727.17285815816, 1809.58945975362, 1155.06194106274, 
677.026928769919, 303.628045003279, 0, 0, 0, 0, 0, 0, 0, 7887.03743114638, 
1213.98571127429, 6772.44860253268, 2727.17285815816, 1885.69966212526, 
1286.30001336205, 843.748751321982, 506.782537740946, 233.396000567154, 
0, 0, -4.54747350886464e-07, 0, 0, 0, 0, 5037.04853463205, 754.938053205478, 
4325.21308266587, 1809.58945975362, 1286.30001336205, 980.193503892224, 
661.64994814244, 407.200678637309, 192.308155419596, 0, 0, -4.54747350886464e-07, 
0, 0, 0, 0, 3088.04326050449, 449.127310730546, 2651.63563562965, 
1155.06194106274, 843.748751321982, 661.64994814244, 532.439771177451, 
336.547421284195, 163.159583735251, 0, 0, 4.54747350886464e-07, 
0, 0, 0, 0, 1741.54023261508, 245.601941514906, 1495.42477038267, 
677.026928769919, 506.782537740946, 407.200678637309, 336.547421284195, 
281.739328329422, 140.54930443308, 0, 0, 4.54747350886464e-07, 
0, 0, 0, 0, 746.805569178832, 101.32384386452, 641.267406535917, 
303.628045003279, 233.396000567154, 192.308155419596, 163.159583735251, 
140.54930443308, 122.071693112957, 0, 0, 4.54747350886464e-07, 
0, 0, 0, 0, 4620.23907903131, 679.144186960912, 0, 0, 0, 0, 0, 
0, 0, 3967.30226702857, 1644.82767740992, 807.181005711755, 486.069544876955, 
278.474720744271, 137.003375130007, 37.5175109184056, 1915.53882314111, 
230.875468787417, 0, 0, 0, 0, 0, 0, 0, 1644.82767740992, 875.477099725686, 
346.638276369049, 203.432355647237, 115.075495159545, 54.5399007023661, 
14.4286423164885, 940.026757234591, 138.203271944803, 0, 0, -4.54747350886464e-07, 
-4.54747350886464e-07, 4.54747350886464e-07, 4.54747350886464e-07, 
4.54747350886464e-07, 807.181005711755, 346.638276369049, 250.846941526106, 
144.640387588879, 81.0865017228934, 37.3870957446343, 9.63004004006507, 
566.068177704437, 84.8153354127135, 0, 0, 0, 0, 0, 0, 0, 486.069544876955, 
203.432355647237, 144.640387588879, 110.247605789482, 61.2064081906283, 
27.3484943136282, 6.81838355376385, 324.305618050857, 49.0339689349639, 
0, 0, 0, 0, 0, 0, 0, 278.474720744271, 115.075495159545, 81.0865017228934, 
61.2064081906283, 47.09732502306, 20.2343594537524, 4.82133191326284, 
159.556260769023, 24.7462162406009, 0, 0, 0, 0, 0, 0, 0, 137.003375130007, 
54.5399007023661, 37.3870957446343, 27.3484943136282, 20.2343594537524, 
14.7110495163361, 3.27586622006493, 43.6977356912394, 6.92689218340092, 
0, 0, 0, 0, 0, 0, 0, 37.5175109184056, 14.4286423164885, 9.63004004006507, 
6.81838355376385, 4.82133191326284, 3.27586622006493, 2.01954662770731
), dim = c(16L, 16L)))
```

Here the starting and the estimated parameters side by side:
```{r}
cbind(start_parms_val,
      estimates_from_integrated_likelihood$par
)

```

# Fit for the placebo group
```{r, include=TRUE, eval=TRUE}
# starting values:
# logk0p = start_parms_val[1]
# g0p = start_parms_val[2]
# delta_vec_p = start_parms_val[ 3:(3+(LTVEC-1))]

# estimated values:
logk0p = estimates_from_integrated_likelihood$par[1]
g0p = estimates_from_integrated_likelihood$par[2]
delta_vec_p = estimates_from_integrated_likelihood$par[ 3:(3+(LTVEC-1))]
```

# Fit for vaccine group

Notice `logk0p`=`logk0v` and `g0p`=`g0v`, the parameters that control the first (leftmost)
piece for the placebo group (p) and the vaccine group (v).
This parameterization forces the first pieces to be the same for both groups (i.e. *ramp-up time*).


```{r alpha-02-knots-fit}
# starting values:
# logk0v = start_parms_val[1]
# g0v = start_parms_val[2]
# delta_vec_v = start_parms_val[ (3+LTVEC):(2*LTVEC+2)]

# estimated values:
logk0v = estimates_from_integrated_likelihood$par[1]
g0v = estimates_from_integrated_likelihood$par[2]
delta_vec_v = estimates_from_integrated_likelihood$par[ (3+LTVEC):(2*LTVEC+2)]
```

```{r, include=FALSE, eval=TRUE}
time<- c(0,14,28,42,56,70,84,98,112,126,140,154,168,182,196)

#F1  <- c(0,.18,.19,.22,.25,.27,.28,.34,.44,.50,.60,.72,.75,.81,.93)/100
#F0  <- c(0,.29,.60,1,1.38,1.75,2.25,2.97,3.50,4.25,4.94,5.53,6.00,6.31,6.94)/100

# F0 <- 1-c(ipd_plac$Points$surv[ipd_plac$Points$time %in% time])
# F1 <- 1-c(ipd_vacc$Points$surv[ipd_vacc$Points$time %in% time])

time_plac <- ipd_plac$Points$time
F0 <- 1-c(ipd_plac$Points$surv)

time_vacc <- ipd_vacc$Points$time
F1 <- 1-c(ipd_vacc$Points$surv)

```

# Plot population avg CDF
  * Quick check of fit

We use the knots and the original time in `time.dist` to do a quick check of the fit.  We put vertical dashed lines in the plot to denote knot placement.

```{r alpha-02-knots-popavg-dist, eval=TRUE, include=TRUE}
time.dist <- sort(c(seq(min(c(time, tvec.in)), 
                        max(c(time, tvec.in)), 0.1),
                    tvec.in)
                  )

plac.dist <- popavg_dist(      x = time.dist, 
                           knots = tvec.in,
                           logk0 = logk0p,
                              g0 = g0p,
                       delta_vec = delta_vec_p,
                          h_parm = H_PARM,
                         frailty = FRAILTY)

vacc.dist <- popavg_dist(      x = time.dist, 
                           knots = tvec.in,
                           logk0 = logk0v,
                              g0 = g0v,
                       delta_vec = delta_vec_v,
                          h_parm = H_PARM,
                         frailty = FRAILTY)
  
plot  (time.dist, plac.dist, type="l", col="#2E9FDF", ylim=c(0,0.08), ylab="Cumulative Incidence",xlab="Day since Receipt of First Dose", 
        main=c("Specified Knots: ",paste(round(tvec.in,1), collapse=", ")), xlim=range(time))
points(time_plac     , F0       , col="#2E9FDF", pch=15)
lines (time.dist, vacc.dist, col="#FF4500")
points(time_vacc     , F1, col="#FF4500", pch=16)
abline(v=tvec.in, lty=2, col="grey")
legend("topleft", c("Placebo", "BNT162b2"),
       col=c("#2E9FDF","#FF4500"),
       lty=1,
       pch=c(15,16)
)
axis(1, at=c(tvec.in[1]))
```




<!-- Note from Days 0 to `r tvec.in[1]` the curves are the same. Over this range the HR will be 1.  Additionally, the fit looks okay -- some points are below their line and some are above. -->



```{r, include=FALSE}
COL <- c("#2E9FDF","grey")
LTY <- c(1,1)
LWD <- c(2,6)
plot(NA,NA,, type="l", col="#2E9FDF", lwd=2, ylim=c(0,0.08), ylab="Cumulative Incidence",xlab="Day since Receipt of First Dose", 
        main=c("Specified Knots: ",paste(round(tvec.in,1), collapse=", ")), xlim=range(time))

time.dist <- sort(c(seq(min(c(time, tvec.in)), 
                        max(c(time, tvec.in)), 0.1),
                    tvec.in)
                  )


plac.dist <- popavg_dist(      x = time.dist, 
                           knots = tvec.in,
                           logk0 = logk0p,
                              g0 = g0p,
                       delta_vec = delta_vec_p,
                          h_parm = H_PARM,
                         frailty = FRAILTY)

vacc.dist <- popavg_dist(      x = time.dist, 
                           knots = tvec.in,
                           logk0 = logk0v,
                              g0 = g0v,
                       delta_vec = delta_vec_v,
                          h_parm = H_PARM,
                         frailty = FRAILTY)



  lines(c(0,time.dist), c(0,vacc.dist),  col=COL[2],lty=LTY[2],lwd=LWD[2])



points(time_vacc, F1, col="#FF4500")
abline(v=tvec.in, lty=2, col="grey")

points(time_plac, F0, col="#2E9FDF")

  lines(c(0,time.dist), c(0,plac.dist),  col=COL[1],lty=LTY[1],lwd=LWD[1])
legend("topleft",legend=c(expression(F[0](t)),expression(F[1](t))),col=COL,
       lty=LTY,lwd=LWD)

```

Note from Days 0 to `r tvec.in[1]` the curves are the same. Over this range the HR will be 1.  Additionally, the fit looks okay -- some points are below their line and some are above.


# Plot population avg HR
  * uses parameters from two step fitting procedure
  * HR(0) = 1

We use the parameters of the previous fits to estimate the 
population average hazard, which we can fit with `mpw::popavg_haz()`.
We adjust the time input so that the first element is just above 0.

```{r alpha-02-knots-popavg-haz}
time.haz <- c(1e-4, time.dist[-1])
plac.haz <- popavg_haz(      x = time.haz, 
                           knots = tvec.in,
                           logk0 = logk0p,
                              g0 = g0p,
                       delta_vec = delta_vec_p,
                          h_parm = H_PARM,
                         frailty = FRAILTY)

vacc.haz <- popavg_haz(      x = time.haz, 
                           knots = tvec.in,
                           logk0 = logk0v,
                              g0 = g0v,
                       delta_vec = delta_vec_v,
                          h_parm = H_PARM,
                         frailty = FRAILTY)

plot  (time.haz, vacc.haz/plac.haz, type="l", col="purple", xlab="Days",
       ylab="Hazard Ratio", lwd=2, ylim=c(-0.05,1.05))

abline(v=tvec.in, lty=2, col="grey")

axis(1, at=c(tvec.in[1]))

```

Or, plot the VE = 1-HR:

# Plot population avg VE=1-HR

```{r alpha-02-knots-popavg-ve}
plot  (time.haz, 1-vacc.haz/plac.haz, type="l", col="purple", xlab="Days",
       ylab="Vaccine Efficacy", lwd=2, ylim=c(-0.05,1.05))

abline(v=tvec.in, lty=2, col="grey")

axis(1, at=c(tvec.in[1]))

```

A nice feature of this analysis is that we can surmise the heterogeneity and make a point in the next section.
  
# Plot subject-specific VEs for different $\alpha$ values
  * The VE should flatten to 1 as $\alpha \rightarrow 0$

In other articles on this website demonstrating `mpw` use cases, adding subject specific curves involves the `mpw::subjspec_haz()` function.  In the $\frac{1}{\alpha}$ approach, we instead use `mpw::popavg_haz()` specifying
h_parm as 1/alpha to plot the subject specific curve.


<!-- Sidenote: This is because the function `mpw::subjspec_haz()` does not require the arguments `frailty` or `h_parm`. The function takes the inputs for the b,k, and delta pieces and models the subject-specific (aka conditional) hazard assuming they were estimated in the presence of a non-unity `h_parm`. -->


```{r alpha-02-knots-subjspec-haz, eval=FALSE, include=FALSE}
plac.haz.ss <- subjspec_haz(      x = time.haz, 
                           knots = tvec.in,
                           logk0 = logk0p,
                              g0 = g0p,
                       delta_vec = delta_vec_p)

vacc.haz.ss <- subjspec_haz(      x = time.haz, 
                           knots = tvec.in,
                           logk0 = logk0v,
                              g0 = g0v,
                       delta_vec = delta_vec_v)

plot  (time.haz, vacc.haz/plac.haz, type="l", col="purple", xlab="Days",
       ylab="Hazard Ratio", lwd=2, ylim=c(-0.05,1.05))

axis(1, at=c(tvec.in[1]))

lines  (time.haz, vacc.haz.ss/plac.haz.ss, type="l", col="gold", xlab="Days",
        lwd=2, lty=2)
legend("topright", c("Population HR", "Subject-specific HR"),
       col=c("purple","gold"),
       lty=c(1,2),
       lwd=2
)

```

To demonstrate how the individual-level VE might be different than the population-level, the code below runs a loop for three specific values of alpha:

```{r}
COL<- gray(c(0.7,.5,0))
LTY<-c(1,2,3)
LWD<-c(6,4,2)

plot(NA,NA,, type="l", col="#2E9FDF", lwd=2, ylim=c(0,1), ylab=expression(VE[h]),xlab="Days since Receipt of First Dose", main=c("Specified knots: ",paste(round(tvec.in,1), collapse=", ")), xlim=range(time))

##set alpha.vec here to plot different conditionals
alpha.vec <- c(0.4,0.7,0.99)

## now plot
for(i in 1:length(alpha.vec)){
  
  a.in <- alpha.vec[i]
  
plac.haz <- popavg_haz(      x = time.haz, 
                           knots = tvec.in,
                           logk0 = logk0p,
                              g0 = g0p,
                       delta_vec = delta_vec_p,
                          h_parm = 1/a.in,
                         frailty = FRAILTY)

vacc.haz <- popavg_haz(      x = time.haz, 
                           knots = tvec.in,
                           logk0 = logk0v,
                              g0 = g0v,
                       delta_vec = delta_vec_v,
                          h_parm = 1/a.in,
                         frailty = FRAILTY)

lines(time.haz, 1-vacc.haz/plac.haz, col=COL[i],lty=LTY[i],lwd=LWD[i])

abline(v=tvec.in, lty=2, col="grey")
}
legend("bottomright",legend=paste0("alpha=",c("0.40","0.70","0.99")),lty=LTY,lwd=LWD,col=COL)

```

The plot above shows that for a positive-stable frailty, as $\alpha$ goes to 0 the subject-specific VE is flatter, approaching VE=1.  Going the opposite direction, as $\alpha$ goes to 1 the VE for an individual approaches that of the population VE.  Conceptually, one might conclude VE is waning over time if alpha is 0.99.  One would not conclude that if alpha was 0.40.  **In both instances, the same population-level VE would be observed.**  Therefore the takeaway is to not make statements about VE looking at population-level curves.
